{"version":3,"sources":["../src/echarts_map_ctrl.js"],"names":["PanelCtrl","_","echarts","EchartsMapCtrl","$scope","$injector","panelDefaults","EchartsOption","sensors","IS_MAP","map","USE_URL","url","request","updateInterval","maps","defaultsDeep","panel","events","on","onInitEditMode","bind","render","updateData","that","xmlhttp","window","XMLHttpRequest","ActiveXObject","onreadystatechange","readyState","status","JSON","parse","responseText","success","data","addSensor","open","send","$timeout","oddSensors","slice","length","i","push","branchName","values","alias","location","coord","j","onDataReceived","IS_DATA_CHANGED","addEditorTab","System","import","getPanelPath","grafanaBootData","settings","panels","pluginId","baseUrl","scope","elem","attrs","ctrl","$panelContainer","find","option","Timer","cardInner","currentLoc","colorArr","echartsData","setHeight","height","row","isString","parseInt","replace","style","myChart","init","importMap","setTimeout","resize","callInterval","timeout","result","func","callBack","interval","context","args","arguments","clearInterval","setInterval","apply","clear","eval","setOption","setTimer","clearTimeout","geo","regions","name","selected","sensor","$panelCard","value","unit","innerHTML","renderingCompleted","templateUrl"],"mappings":"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","file":"echarts_map_ctrl.js","sourcesContent":["import { PanelCtrl } from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport echarts from './libs/echarts.min';\r\nimport './libs/dark';\r\nimport './style.css!';\r\nimport './libs/bmap.js';\r\nimport './libs/getBmap.js';\r\nexport class EchartsMapCtrl extends PanelCtrl {\r\n\r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n\r\n        const panelDefaults = {\r\n            EchartsOption: 'option = {}',\r\n            sensors: [],\r\n            IS_MAP: false,\r\n            map: '',\r\n            USE_URL: false,\r\n            url: '',\r\n            request: '',\r\n            updateInterval: 10000\r\n        };\r\n\r\n        this.maps = ['世界', '中国', '北京'];\r\n\r\n        _.defaultsDeep(this.panel, panelDefaults);\r\n\r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        this.events.on('panel-initialized', this.render.bind(this));\r\n\r\n        this.updateData();\r\n    }\r\n\r\n    //post请求\r\n    updateData() {\r\n        let that = this, xmlhttp;\r\n\r\n        if (window.XMLHttpRequest) {\r\n            xmlhttp = new XMLHttpRequest();\r\n        } else {\r\n            xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\r\n        }\r\n\r\n        xmlhttp.onreadystatechange = function () {\r\n            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {\r\n                if (!JSON.parse(xmlhttp.responseText).success) return;\r\n                that.data = JSON.parse(xmlhttp.responseText).data;\r\n                that.addSensor();\r\n            }\r\n        };\r\n\r\n        if (that.panel.url) {\r\n            xmlhttp.open(\"POST\", that.panel.url, true);\r\n            xmlhttp.send(\"input=grafana\");\r\n        }\r\n\r\n        this.$timeout(() => { this.updateData(); }, that.panel.updateInterval);\r\n    }\r\n\r\n    addSensor() {\r\n        let oddSensors = this.panel.sensors.slice(); // 保存原数据\r\n        this.panel.sensors.length = 0; // 清空现有数据\r\n\r\n        // 添加新数据，对比原数据，以保留坐标信息\r\n        for (let i = 0; i < this.data.length; i++) {\r\n            this.panel.sensors.push({ branchName: this.data[i].branchName, status: this.data[i].status, values: this.data[i].values, alias: this.data[i].branchName, location: '北京', coord: [116, 40] });\r\n\r\n            for (let j = 0; j < oddSensors.length; j++) {\r\n                if (this.data[i].branchName == oddSensors[j].branchName) {\r\n                    this.panel.sensors[i].alias = oddSensors[j].alias;\r\n                    this.panel.sensors[i].location = oddSensors[j].location;\r\n                    this.panel.sensors[i].coord = oddSensors[j].coord;\r\n                }\r\n            }\r\n        }\r\n        this.onDataReceived();\r\n    }\r\n\r\n    onDataReceived() {\r\n        this.IS_DATA_CHANGED = true;\r\n        this.render();\r\n        this.IS_DATA_CHANGED = false;\r\n    }\r\n\r\n    // deleteSensor(index) {\r\n    //     this.panel.sensors.splice(index, 1);\r\n    // }\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('数据', 'public/plugins/grafana-echarts-map-panel/editor_mark.html', 2);\r\n        this.addEditorTab('Echarts配置', 'public/plugins/grafana-echarts-map-panel/editor_option.html', 3);\r\n    }\r\n\r\n    importMap() {\r\n        if (!this.panel.IS_MAP) return;\r\n        switch (this.panel.map) {\r\n            case '世界':\r\n                System.import(this.getPanelPath() + 'libs/world.js');\r\n                break;\r\n            case '中国':\r\n                System.import(this.getPanelPath() + 'libs/china.js');\r\n                break;\r\n            case '北京':\r\n                System.import(this.getPanelPath() + 'libs/beijing.js');\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n\r\n    getPanelPath() {\r\n        // the system loader preprends publib to the url, add a .. to go back one level\r\n        return '../' + grafanaBootData.settings.panels[this.pluginId].baseUrl + '/';\r\n    }\r\n\r\n    link(scope, elem, attrs, ctrl) {\r\n        const $panelContainer = elem.find('.echarts_map_container')[0];\r\n        let option = {},\r\n            Timer,\r\n            cardInner = '',\r\n            currentLoc = 0,\r\n            colorArr = ['#3aae32', '#fe8f02', '#c23531'],\r\n            echartsData = [];\r\n\r\n        ctrl.IS_DATA_CHANGED = true;\r\n\r\n        function setHeight() {\r\n            let height = ctrl.height || panel.height || ctrl.row.height;\r\n            if (_.isString(height)) {\r\n                height = parseInt(height.replace('px', ''), 10);\r\n            }\r\n            // height -= 7;\r\n            // height -= ctrl.panel.title ? 25 : 9;\r\n            $panelContainer.style.height = height + 'px';\r\n        }\r\n\r\n        // function setWidth() {\r\n        //     let width = document.body.clientWidth;\r\n        //     width = (width - 5.6 * 2) * ctrl.panel.span / 12 - 5.6 * 2 - 1 * 2 - 10 * 2;\r\n        //     $panelContainer.style.width = width + 'px';\r\n        // }\r\n\r\n        setHeight();\r\n        // setWidth();\r\n\r\n        let myChart = echarts.init($panelContainer, 'dark');\r\n\r\n        ctrl.importMap();\r\n\r\n        // bad hank\r\n        setTimeout(function () {\r\n            myChart.resize();\r\n        }, 1000);\r\n\r\n        // 防止重复触发事件\r\n        var callInterval = function callInterval() {\r\n            var timeout, result;\r\n\r\n            function func(callBack, interval) {\r\n                var context = this; // jshint ignore:line\r\n                var args = arguments;\r\n\r\n                if (timeout) clearInterval(timeout);\r\n\r\n                timeout = setInterval(function () {\r\n                    result = callBack.apply(context, args);\r\n                }, interval);\r\n\r\n                return result;\r\n            }\r\n\r\n            return func;\r\n        }();\r\n\r\n        function render() {\r\n            if (!myChart) {\r\n                return;\r\n            }\r\n\r\n            setHeight();\r\n            myChart.resize();\r\n\r\n            if (ctrl.IS_DATA_CHANGED) {\r\n                myChart.clear();\r\n                echartsData = ctrl.panel.sensors;\r\n            }\r\n\r\n            eval(ctrl.panel.EchartsOption); // jshint ignore:line\r\n            myChart.setOption(option);\r\n\r\n            setTimer();\r\n        }\r\n\r\n        //轮播计时器\r\n        function setTimer() {\r\n            clearTimeout(Timer);\r\n\r\n            if (ctrl.panel.sensors.length > 0) {\r\n                myChart.setOption({\r\n                    geo: {\r\n                        regions: [{\r\n                            name: ctrl.panel.sensors[currentLoc].location,\r\n                            selected: true\r\n                        }]\r\n                    }\r\n                });\r\n\r\n                ctrl.sensor = ctrl.panel.sensors[currentLoc];\r\n\r\n                let $panelCard = elem.find('.map_card_container')[0];\r\n                if ($panelCard) {\r\n                    cardInner = '<div class = \"card\"><div class=\"title\"><i class=\"icon\" style=\"background:' + colorArr[ctrl.sensor.status % 3] + ';\"></i>' + ctrl.sensor.alias + '</div>';\r\n\r\n                    for (let j = 0; j < ctrl.sensor.values.length; j++) {\r\n                        cardInner += '<div class=\"info\">' + ' <span class=\"text\">' + ctrl.sensor.values[j].name + '</span>' + ' <span class=\"value\">' + ctrl.sensor.values[j].value + '</span>' + ' <span class=\"text\">' + ctrl.sensor.values[j].unit + '</span>' + '</div>';\r\n                    }\r\n\r\n                    $panelCard.innerHTML = cardInner + '</div>';\r\n                }\r\n\r\n                currentLoc = (currentLoc + 1) % ctrl.panel.sensors.length;\r\n\r\n                Timer = setTimeout(setTimer, 3600);\r\n            }\r\n        }\r\n\r\n        this.events.on('render', function () {\r\n            render();\r\n            ctrl.renderingCompleted();\r\n        });\r\n    }\r\n}\r\n\r\nEchartsMapCtrl.templateUrl = 'module.html';\r\n"]}